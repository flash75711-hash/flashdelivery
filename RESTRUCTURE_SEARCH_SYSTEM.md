# ุฅุนุงุฏุฉ ููููุฉ ูุธุงู ุงูุจุญุซ - ููุฎุต ุงูุชุบููุฑุงุช

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุนุงุฏุฉ ููููุฉ ูุธุงู ุงูุจุญุซ ุนู ุงูุณุงุฆููู ูู ูุธุงู ูุฑุญูุชูู (5 ูู ููุฏุฉ 30 ุซุงููุฉ ุซู 10 ูู ููุฏุฉ 30 ุซุงููุฉ) ุฅูู ูุธุงู ูุฑุญูุฉ ูุงุญุฏุฉ (10 ูู ููุฏุฉ 60 ุซุงููุฉ).

## โ ุงูุชุบููุฑุงุช ุงููุทุจูุฉ

### 1. ุชุนุฏูู `start-order-search` Edge Function
**ุงูููู**: `supabase/functions/start-order-search/index.ts`

**ุงูุชุบููุฑุงุช**:
- โ ุฅุฒุงูุฉ ููุทู ุงููุฑุญูุชูู (initial ู expanded)
- โ ุงูุจุญุซ ูุจุงุดุฑุฉ ุนูู 10 ูู ููุฏุฉ 60 ุซุงููุฉ
- โ ุญุณุงุจ ุงููุณุงูุฉ ูู ูููุน ูู ุณุงุฆู ุฅูู ุฃูู ููุงู ุณูุฐูุจ ุฅููู (ูู `order_items`)
- โ ุชุญุฏูุซ ุฑุณุงุฆู ุงูุฅุดุนุงุฑุงุช ูุชุดูู ุงููุณุงูุฉ: `"ุทูุจ ุฌุฏูุฏ ูุชุงุญ - ุงููุณุงูุฉ: X ูู"`
- โ ุฅุถุงูุฉ `distance_to_first_place_km` ูู ุจูุงูุงุช Push Notification

**ุงูููู ุงูุงูุชุฑุงุถูุฉ**:
- ูุทุงู ุงูุจุญุซ: 10 ูู
- ูุฏุฉ ุงูุจุญุซ: 60 ุซุงููุฉ

### 2. ุชุจุณูุท `OrderSearchCountdown` Component
**ุงูููู**: `components/OrderSearchCountdown.tsx`

**ุงูุชุบููุฑุงุช**:
- โ ุฅุฒุงูุฉ ููุทู ุงูุชูุณูุน ูุงููุฑุญูุชูู
- โ ุฅุฒุงูุฉ `fastPollingActiveRef` ู `sessionRetryCountRef` ููู ููุทู ุงูุชูุณูุน
- โ ุชุจุณูุท ุงููููู ููุนูู ูุน ูุฑุญูุฉ ูุงุญุฏุฉ ููุท
- โ ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ูุงุณุชุฎุฏุงู `search_radius_km` ู `search_duration_seconds`

### 3. Migration ูุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
**ุงูููู**: `migrations/update_search_to_single_phase.sql`

**ุงูุชุบููุฑุงุช**:
- โ ุชุญุฏูุซ `initial_search_radius_km` ุฅูู 10
- โ ุชุญุฏูุซ `initial_search_duration_seconds` ุฅูู 60
- โ ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช ุฌุฏูุฏุฉ: `search_radius_km` ู `search_duration_seconds`

### 4. ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช
**ุงูููู**: `supabase/functions/start-order-search/index.ts`

**ุงูุชุบููุฑุงุช**:
- โ ุฑุณุงูุฉ In-App Notification: `"ุทูุจ ุฌุฏูุฏ ูุชุงุญ - ุงููุณุงูุฉ: X ูู"`
- โ ุฑุณุงูุฉ Push Notification: `"ุทูุจ ุฌุฏูุฏ ูุชุงุญ - ุงููุณุงูุฉ: X ูู"`
- โ ุฅุถุงูุฉ `distance_to_first_place_km` ูู `data` ููู Push Notification

## ๐ ููููุฉ ุญุณุงุจ ุงููุณุงูุฉ

### ุงููุณุงูุฉ ุงููุนุฑูุถุฉ ููุณุงุฆู:
1. **ุฅุฐุง ูุงู ููุงู `order_items`**: ุงููุณุงูุฉ ูู ูููุน ุงูุณุงุฆู ุฅูู ุฃูู ุนูุตุฑ ูู `order_items` (ุฃูู ููุงู ุณูุฐูุจ ุฅููู)
2. **ุฅุฐุง ูู ููู ููุงู `order_items`**: ุงููุณุงูุฉ ูู ูููุน ุงูุณุงุฆู ุฅูู `search_point` (ููุทุฉ ุงูุจุญุซ)

### ูุซุงู:
```
ุงูุณุงุฆู ูู: (24.7136, 46.6753)
ุฃูู ููุงู ูู order_items: (24.7200, 46.6800)
ุงููุณุงูุฉ ุงููุญุณูุจุฉ: 0.8 ูู
```

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ุชุทุจูู Migration
```sql
-- ุชุดุบูู migration
\i migrations/update_search_to_single_phase.sql
```

### 2. ุชุญุฏูุซ Edge Function
```bash
# ูุดุฑ start-order-search
supabase functions deploy start-order-search
```

### 3. ุงุฎุชุจุงุฑ ุงููุธุงู
- โ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ
- โ ุงูุชุญูู ูู ุฃู ุงูุจุญุซ ูุจุฏุฃ ูุจุงุดุฑุฉ ุนูู 10 ูู
- โ ุงูุชุญูู ูู ุฃู ุงูุนุฏุงุฏ ูุนุฑุถ 60 ุซุงููุฉ
- โ ุงูุชุญูู ูู ุฃู ุงูุฅุดุนุงุฑุงุช ุชุญุชูู ุนูู ุงููุณุงูุฉ

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. `expand-order-search` Edge Function
- **ุงูุญุงูุฉ**: ูู ูุชู ุญุฐููุง (ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู)
- **ุงูุชูุตูุฉ**: ูููู ุญุฐููุง ูุงุญูุงู ุฅุฐุง ูู ุชุนุฏ ููุงู ุญุงุฌุฉ ุฅูููุง

### 2. ุงูุฅุนุฏุงุฏุงุช ุงููุฏููุฉ
- **ุงูุญุงูุฉ**: ุชู ุงูุงุญุชูุงุธ ุจู `initial_search_radius_km` ู `initial_search_duration_seconds` ููุชูุงูู
- **ุงูุชูุตูุฉ**: ูููู ุญุฐููุง ูุงุญูุงู ุจุนุฏ ุงูุชุฃูุฏ ูู ุฃู ูู ุงูููุฏ ูุณุชุฎุฏู ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ

### 3. ุงูุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
- ุงูููุฏ ุงูุฌุฏูุฏ ูุฏุนู ููุงู ูู:
  - `search_radius_km` / `search_duration_seconds` (ุฌุฏูุฏ)
  - `initial_search_radius_km` / `initial_search_duration_seconds` (ูุฏูู)

## ๐ ุฃูุซูุฉ ุนูู ุงูุฅุดุนุงุฑุงุช

### ูุจู ุงูุชุญุฏูุซ:
```
"ุทูุจ ุฌุฏูุฏ ูุชุงุญ ูู ูุทุงู 5 ูู"
```

### ุจุนุฏ ุงูุชุญุฏูุซ:
```
"ุทูุจ ุฌุฏูุฏ ูุชุงุญ - ุงููุณุงูุฉ: 2.3 ูู"
```

## โ ุงูุชุญูู ูู ุงูุชุทุจูู

### 1. ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช:
```sql
SELECT setting_key, setting_value 
FROM order_search_settings 
WHERE setting_key IN ('search_radius_km', 'search_duration_seconds');
```

### 2. ุงูุชุญูู ูู ุงูุฅุดุนุงุฑุงุช:
```sql
SELECT message, created_at 
FROM notifications 
WHERE order_id = 'YOUR_ORDER_ID' 
ORDER BY created_at DESC 
LIMIT 5;
```

### 3. ุงูุชุญูู ูู Logs:
```
[start-order-search] ๐ Search configuration: 10 km radius, 60 seconds duration
[start-order-search] Notifying driver XXX (distance to first place: 2.3 ูู)...
```

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

- โ ุงูุจุญุซ ูุจุฏุฃ ูุจุงุดุฑุฉ ุนูู 10 ูู ููุฏุฉ 60 ุซุงููุฉ
- โ ูู ุณุงุฆู ูุฑู ุงููุณุงูุฉ ูู ูููุนู ุฅูู ุฃูู ููุงู ุณูุฐูุจ ุฅููู
- โ ุงูุนุฏุงุฏ ูุนุฑุถ ุงูููุช ุงููุชุจูู ุจุดูู ุตุญูุญ
- โ ุงูุฅุดุนุงุฑุงุช ุชุญุชูู ุนูู ูุนูููุงุช ุงููุณุงูุฉ
