# دليل إعدادات مزامنة الأماكن

## نظرة عامة

تم إضافة نظام متقدم للتحكم في التحديث التلقائي لدليل الأماكن (المولات، الأسواق، المناطق) من لوحة الإدارة.

## المميزات

### 1. التحكم في التحديث التلقائي
- ✅ تفعيل/تعطيل التحديث التلقائي لكل مدينة
- ✅ تحديد فترة التحديث (عدد الأيام)
- ✅ تحديد أنواع الأماكن التي يتم مزامنتها (مولات، أسواق، مناطق)
- ✅ تحديد أولوية كل مدينة

### 2. تحسينات خاصة لمدينة السادات
- ✅ مصطلحات بحث محسّنة (مولات، أسواق، مناطق)
- ✅ زيادة الحد الأقصى للنتائج (30 بدلاً من 15)
- ✅ تقليل التأخير بين الطلبات (500ms بدلاً من 1000ms)
- ✅ أولوية عالية (100) في الإعدادات الافتراضية

### 3. مزامنة يدوية
- ✅ إمكانية مزامنة أي مدينة يدوياً من لوحة الإدارة
- ✅ تحديث `last_sync_at` تلقائياً بعد المزامنة

## الوصول إلى الصفحة

1. افتح لوحة الإدارة (`/(tabs)/admin/dashboard`)
2. اضغط على "إدارة الأماكن" أو "إعدادات مزامنة الأماكن"
3. أو افتح مباشرة: `/(tabs)/admin/places-sync-settings`

## استخدام الصفحة

### إضافة مدينة جديدة
1. اضغط على "إضافة مدينة جديدة"
2. أدخل اسم المدينة
3. اضغط "إضافة"
4. سيتم إنشاء إعدادات افتراضية:
   - التحديث التلقائي: مفعّل
   - فترة التحديث: 7 أيام
   - جميع أنواع الأماكن: مفعّلة
   - الأولوية: 0

### تعديل إعدادات مدينة
1. اضغط "تعديل" بجانب المدينة
2. غيّر الإعدادات المطلوبة:
   - **التحديث التلقائي**: تفعيل/تعطيل
   - **مدة التحديث**: عدد الأيام بين كل تحديث
   - **الأولوية**: رقم الأولوية (الأعلى أولاً)
   - **أنواع الأماكن**: مولات، أسواق، مناطق
3. اضغط "حفظ"

### مزامنة يدوية
1. اضغط "مزامنة" بجانب المدينة
2. سيتم مزامنة جميع أنواع الأماكن المفعّلة
3. سيتم تحديث `last_sync_at` تلقائياً

### حذف مدينة
1. اضغط "حذف" بجانب المدينة
2. أكّد الحذف
3. سيتم حذف إعدادات المدينة (لكن الأماكن المحفوظة تبقى)

## إعدادات مدينة السادات الافتراضية

```sql
city_name: 'السادات'
auto_sync_enabled: true
sync_interval_days: 7
sync_malls: true
sync_markets: true
sync_areas: true
priority: 100 (أولوية عالية جداً)
```

## كيف يعمل النظام

### 1. عند فتح دليل الأماكن
- يتم جلب إعدادات المزامنة للمدينة الحالية
- إذا كان التحديث التلقائي مفعّلاً:
  - يتم التحقق من `last_api_update`
  - إذا كان أقدم من `sync_interval_days`، يتم المزامنة تلقائياً
- إذا كان التحديث التلقائي معطّلاً:
  - يتم عرض الأماكن الموجودة فقط
  - لا يتم المزامنة تلقائياً

### 2. عند المزامنة
- يتم استدعاء Edge Function `sync-places`
- يتم البحث في Nominatim API باستخدام مصطلحات محسّنة
- يتم حفظ/تحديث الأماكن في قاعدة البيانات
- يتم تحديث `last_sync_at` في إعدادات المزامنة

### 3. تحسينات مدينة السادات
- **مصطلحات بحث إضافية**:
  - مولات: 'مركز تسوق', 'سوق تجاري'
  - أسواق: 'سوبرماركت', 'بقالة', 'ميني ماركت'
  - مناطق: 'قطاع', 'شارع', 'طريق'
- **زيادة النتائج**: 30 بدلاً من 15
- **سرعة أكبر**: تأخير 500ms بدلاً من 1000ms

## الجدول: places_sync_settings

```sql
CREATE TABLE places_sync_settings (
  id UUID PRIMARY KEY,
  city_name TEXT UNIQUE NOT NULL,
  auto_sync_enabled BOOLEAN DEFAULT true,
  sync_interval_days INTEGER DEFAULT 7,
  sync_malls BOOLEAN DEFAULT true,
  sync_markets BOOLEAN DEFAULT true,
  sync_areas BOOLEAN DEFAULT true,
  priority INTEGER DEFAULT 0,
  last_sync_at TIMESTAMP WITH TIME ZONE,
  next_sync_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## RLS Policies

- **القراءة**: جميع المستخدمين
- **الكتابة**: فقط الـ admins

## ملاحظات مهمة

1. **الأماكن اليدوية**: لا يتم تحديثها تلقائياً أبداً
2. **Cache**: Edge Function يمنع المزامنة المتزامنة (آخر دقيقة)
3. **الأولوية**: المدن ذات الأولوية الأعلى تظهر أولاً في القائمة
4. **next_sync_at**: يتم تحديثه تلقائياً عند تحديث `last_sync_at`

## الخطوات التالية (اختياري)

1. إضافة أماكن يدوية لمدينة السادات من لوحة الإدارة
2. إضافة مدن أخرى حسب الحاجة
3. ضبط الأولويات حسب الأهمية

## استكشاف الأخطاء

### المشكلة: لا يتم المزامنة تلقائياً
- ✅ تحقق من أن `auto_sync_enabled = true`
- ✅ تحقق من أن `sync_interval_days` قد مرت منذ آخر مزامنة
- ✅ تحقق من أن نوع المكان (mall/market/area) مفعّل

### المشكلة: المزامنة بطيئة
- ✅ مدينة السادات محسّنة تلقائياً (500ms delay, 30 results)
- ✅ يمكن تقليل `sync_interval_days` للمدن المهمة

### المشكلة: لا توجد نتائج
- ✅ تحقق من صحة اسم المدينة
- ✅ جرب المزامنة اليدوية
- ✅ تحقق من logs في Edge Function

