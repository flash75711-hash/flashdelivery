# ๐ ูุธุงู ุฅุนุงุฏุฉ ุงููุญุงููุงุช ุงูุชููุงุฆูุฉ ูุงูุนุฏ ุงูุชูุงุฒูู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุฅุนุงุฏุฉ ูุญุงููุงุช ุงูุจุญุซ ุนู ุงูุณุงุฆููู ูุน countdown timer ูุฅููุงููุฉ ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ.

---

## โจ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1๏ธโฃ **ููุณุงุฆู** ๐
- โ **Countdown Timer ููู ุทูุจ** (30 ุซุงููุฉ ุงูุชุฑุงุถูุงู)
- โ **Progress Bar ููุถุญ ุงูููุช ุงููุชุจูู**
- โ **ุฅุฎูุงุก ุชููุงุฆู ููุทูุจ** ุนูุฏ ุงูุชูุงุก ุงูููุช
- โ **ุฅุฎูุงุก ุงูุทูุจุงุช** ุงูููุจููุฉ ูู ุณุงุฆู ุขุฎุฑ

### 2๏ธโฃ **ููุนููู** ๐ค
- โ **Countdown Timer ููุถุญ ุญุงูุฉ ุงูุจุญุซ**
- โ **ุนุฏุงุฏ ุงููุญุงููุงุช** (ุงููุญุงููุฉ 1 ูู 3)
- โ **ุฅุนุงุฏุฉ ุฅุฑุณุงู ุชููุงุฆูุฉ** ูู 3 ูุญุงููุงุช
- โ **ุฒุฑ ุฅุนุงุฏุฉ ุฅุฑุณุงู ูุฏูู** ุจุนุฏ ุงูุชูุงุก ุงููุญุงููุงุช ุงูุชููุงุฆูุฉ

### 3๏ธโฃ **ููุฅุฏุงุฑุฉ** ๐จโ๐ผ
- โ **ุตูุญุฉ ุฅุนุฏุงุฏุงุช** ูุชุนุฏูู ุงููุญุงููุงุช ูุงูููุช
- โ **ุชุญุฏูุซ ููุฑู** ููุฅุนุฏุงุฏุงุช
- โ **ูุงุฌูุฉ ุณููุฉ ุงูุงุณุชุฎุฏุงู**

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `app_settings`
```sql
CREATE TABLE app_settings (
  id UUID PRIMARY KEY,
  setting_key TEXT UNIQUE NOT NULL,
  setting_value TEXT NOT NULL,
  setting_type TEXT CHECK (setting_type IN ('number', 'text', 'boolean')),
  description TEXT,
  category TEXT DEFAULT 'general',
  updated_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
| ุงูููุชุงุญ | ุงููููุฉ | ุงููุตู |
|---------|--------|-------|
| `driver_response_timeout` | 30 | ูุฏุฉ ุงูุชุธุงุฑ ุฑุฏ ุงูุณุงุฆู (ุซุงููุฉ) |
| `max_auto_retry_attempts` | 3 | ุนุฏุฏ ุงููุญุงููุงุช ุงูุชููุงุฆูุฉ |
| `retry_interval` | 30 | ุงููุงุตู ุจูู ูู ูุญุงููุฉ (ุซุงููุฉ) |

### ุฃุนูุฏุฉ ุฌุฏูุฏุฉ ูู `orders`
- `driver_response_deadline` - ููุนุฏ ุงูุชูุงุก ุงูุฑุฏ
- `retry_count` - ุนุฏุฏ ุงููุญุงููุงุช ุงูุญุงูู
- `last_retry_at` - ููุช ุขุฎุฑ ูุญุงููุฉ

---

## ๐ง Functions

### `get_app_setting(p_key TEXT)`
ุฌูุจ ูููุฉ ุฅุนุฏุงุฏ ูุนูู

```sql
SELECT get_app_setting('max_auto_retry_attempts');
```

### `update_app_setting(p_key TEXT, p_value TEXT, p_user_id UUID)`
ุชุญุฏูุซ ุฅุนุฏุงุฏ (ูููุฏุฑุงุก ููุท)

```sql
SELECT update_app_setting('max_auto_retry_attempts', '5', user_id);
```

### `retry_order_search(p_order_id UUID)`
ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุจุญุซ ุนู ุณุงุฆู

```sql
SELECT retry_order_search('order-id-here');
```

---

## ๐ฑ ุงูููููุงุช (Components)

### `OrderCountdownBar`
**ุงูููุงู:** `components/OrderCountdownBar.tsx`

**Props:**
- `deadline` - ููุนุฏ ุงูุชูุงุก ุงูุฑุฏ
- `totalSeconds` - ุฅุฌูุงูู ุงูุซูุงูู (ุงูุชุฑุงุถู: 30)
- `onExpire` - callback ุนูุฏ ุงูุชูุงุก ุงูููุช

**ุงูุงุณุชุฎุฏุงู:**
```tsx
<OrderCountdownBar
  deadline={order.driver_response_deadline}
  totalSeconds={30}
  onExpire={() => handleOrderExpire(order.id)}
/>
```

---

## ๐ฃ Hooks

### `useOrderCountdown`
**ุงูููุงู:** `hooks/useOrderCountdown.ts`

**ุงููุฏุฎูุงุช:**
- `deadline` - string | null

**ุงููุฎุฑุฌุงุช:**
```typescript
{
  timeLeft: number,        // ุงูููุช ุงููุชุจูู ุจุงูุซูุงูู
  isExpired: boolean,      // ูู ุงูุชูู ุงูููุชุ
  getProgress: (total) => number,  // ูุณุจุฉ ุงูุชูุฏู (0-100)
  formatTime: () => string  // ุชูุณูู ุงูููุช (MM:SS)
}
```

### `useAutoRetry`
**ุงูููุงู:** `hooks/useAutoRetry.ts`

**ุงููุฏุฎูุงุช:**
- `orderId` - string | null
- `enabled` - boolean (ุงูุชุฑุงุถู: true)

**ุงููุฎุฑุฌุงุช:**
```typescript
{
  retryCount: number,      // ุนุฏุฏ ุงููุญุงููุงุช ุงูุญุงูู
  maxRetries: number,      // ุงูุญุฏ ุงูุฃูุตู ูููุญุงููุงุช
  isRetrying: boolean,     // ูู ูุชู ุฅุนุงุฏุฉ ุงููุญุงููุฉุ
  manualRetry: () => Promise<boolean>  // ุฅุนุงุฏุฉ ูุญุงููุฉ ูุฏููุฉ
}
```

---

## ๐ฏ ุงูุณููุงุฑูู ุงููุงูู

### 1. **ุงูุนููู ููุดุฆ ุทูุจ**
```
ุงูุนููู ูุถุบุท "ุฅูุดุงุก ุทูุจ"
  โ
ุงููุธุงู ููุดุฆ ุงูุทูุจ ูุน:
  - status = 'pending'
  - driver_id = null
  - driver_response_deadline = NOW() + 30 seconds
  - retry_count = 0
  โ
ุงูุทูุจ ูุธูุฑ ุนูุฏ ุฌููุน ุงูุณุงุฆููู
```

### 2. **ุงูุณุงุฆู ูุฑู ุงูุทูุจ**
```
ุงูุณุงุฆู ููุชุญ ุตูุญุฉ "ุฑุญูุงุช ุฌุฏูุฏุฉ"
  โ
ูุฑู:
  - ุชูุงุตูู ุงูุทูุจ
  - Countdown timer (30 ุซุงููุฉ)
  - Progress bar
  - ุฒุฑ "ูุจูู ุงูุทูุจ"
  โ
ุฅุฐุง ุงูุชูู ุงูููุช:
  - ุงูุทูุจ ูุฎุชูู ุชููุงุฆูุงู ูู UI ุงูุณุงุฆู
```

### 3. **ุงูุนููู ูุชุงุจุน**
```
ุงูุนููู ููุชุญ "ุทูุจุงุชู"
  โ
ูุฑู:
  - Countdown timer
  - "ุฌุงุฑู ุงูุจุญุซ ุนู ุณุงุฆู..."
  - "ุงููุญุงููุฉ 1 ูู 3"
  โ
ุจุนุฏ 30 ุซุงููุฉ (ุฅุฐุง ูู ููุจู ุณุงุฆู):
  โ
ุงููุธุงู ุชููุงุฆูุงู:
  1. retry_count++
  2. driver_response_deadline = NOW() + 30s
  3. ุงูุทูุจ ูุธูุฑ ูุฑุฉ ุฃุฎุฑู ููุณุงุฆููู
  โ
ูุชูุฑุฑ ุญุชู 3 ูุญุงููุงุช
```

### 4. **ุจุนุฏ 3 ูุญุงููุงุช**
```
ุฅุฐุง ูู ููุจู ุฃู ุณุงุฆู:
  โ
ุงูุนููู ูุฑู:
  - "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุงุฆู"
  - ุฒุฑ "๐ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู"
  โ
ุงูุนููู ูุถุบุท "ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู":
  - retry_count = 0
  - ุชุจุฏุฃ ุงูุฏูุฑุฉ ูู ุฌุฏูุฏ
```

---

## ๐ ุงูุฃูุงู (RLS)

### `app_settings`
- **ุงููุฑุงุกุฉ:** ุงูุฌููุน โ
- **ุงูุชุนุฏูู:** ุงููุฏุฑุงุก ููุท โ

```sql
-- ุงูุฌููุน ูููููู ูุฑุงุกุฉ ุงูุฅุนุฏุงุฏุงุช
CREATE POLICY "Everyone can read settings"
  ON app_settings FOR SELECT
  USING (true);

-- ุงููุฏุฑุงุก ููุท ูููููู ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช
CREATE POLICY "Admins can manage settings"
  ON app_settings FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );
```

---

## ๐ ุตูุญุฉ ุฅุนุฏุงุฏุงุช ุงูุฅุฏุงุฑุฉ

**ุงูููุงู:** `app/(tabs)/admin/settings.tsx`

**ุงููุตูู:** `/admin/settings` (ูููุฏุฑุงุก ููุท)

**ุงูููุฒุงุช:**
- ๐ ุชุนุฏูู ุนุฏุฏ ุงููุญุงููุงุช ุงูุชููุงุฆูุฉ
- โฑ๏ธ ุชุนุฏูู ูุฏุฉ ุงูุงูุชุธุงุฑ
- โ ุญูุธ ููุฑู
- ๐ ุฅุนุงุฏุฉ ุชุนููู ุงูููู

---

## ๐จ UI/UX

### ููุณุงุฆู
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุชูุตูู ุทุฑุฏ                    โ
โ  ๐ ูู: ุงููุงูุฑุฉ โ ุงูุฌูุฒุฉ          โ
โ  ๐ฐ 50 ุฌ.ู                       โ
โ                                  โ
โ  โฑ๏ธ 00:25                        โ
โ  [โโโโโโโโโโโโโโโโ] 25/30       โ  โ Progress bar
โ  ุงูุฑุฏ ุฎูุงู 25 ุซุงููุฉ              โ
โ                                  โ
โ  [ูุจูู ุงูุทูุจ]                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ููุนููู
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุทูุจู ููุฏ ุงููุนุงูุฌุฉ               โ
โ  ๐ ุฌุงุฑู ุงูุจุญุซ ุนู ุณุงุฆู...       โ
โ                                  โ
โ  โฑ๏ธ 00:18                        โ
โ  [โโโโโโโโโโโโโโโโโโ] 18/30     โ
โ  ุงูุฑุฏ ุฎูุงู 18 ุซุงููุฉ              โ
โ                                  โ
โ  ุงููุญุงููุฉ 1 ูู 3                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// ุจุนุฏ 3 ูุญุงููุงุช:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุงุฆู      โ
โ                                  โ
โ  [๐ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู]             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุนูุฏ ุงูุณุงุฆู
```bash
# 1. ุงูุชุญ ุตูุญุฉ ุฑุญูุงุช ุงูุณุงุฆู
# 2. ุชุฃูุฏ ูู ุธููุฑ countdown timer
# 3. ุงูุชุธุฑ 30 ุซุงููุฉ
# 4. ุชุฃูุฏ ูู ุงุฎุชูุงุก ุงูุทูุจ ุชููุงุฆูุงู
```

### 2. ุงุฎุชุจุงุฑ ุนูุฏ ุงูุนููู
```bash
# 1. ุฃูุดุฆ ุทูุจ ุฌุฏูุฏ
# 2. ุชุฃูุฏ ูู ุธููุฑ countdown timer
# 3. ุชุฃูุฏ ูู ุธููุฑ "ุงููุญุงููุฉ 1 ูู 3"
# 4. ุงูุชุธุฑ ุญุชู ุชูุชูู 3 ูุญุงููุงุช
# 5. ุชุฃูุฏ ูู ุธููุฑ ุฒุฑ "ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู"
# 6. ุงุถุบุท ุงูุฒุฑ ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู
```

### 3. ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุฅุฏุงุฑุฉ
```bash
# 1. ุณุฌู ุฏุฎูู ููุฏูุฑ
# 2. ุงูุชุญ /admin/settings
# 3. ุบููุฑ "max_auto_retry_attempts" ูู 3 ุฅูู 5
# 4. ุงุญูุธ ุงูุชุบููุฑุงุช
# 5. ุฃูุดุฆ ุทูุจ ุฌุฏูุฏ ูุชุฃูุฏ ูู ุงูุชุทุจูู
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงูุทูุจ ูุง ูุฎุชูู ุนูุฏ ุงูุณุงุฆู
**ุงูุญู:** ุชุฃูุฏ ูู ุฃู `driver_response_deadline` ููุฌูุฏ ูู ุงูุทูุจ

### ุฒุฑ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู ูุง ูุธูุฑ
**ุงูุญู:** ุชุฃูุฏ ูู:
- `retry_count >= max_auto_retry_attempts`
- `status === 'pending'`
- `driver_id === null`

### ุงูุฅุนุฏุงุฏุงุช ูุง ุชุชุญุฏุซ
**ุงูุญู:** ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู `role = 'admin'`

---

## ๐ ุฅุญุตุงุฆูุงุช

```sql
-- ุนุฏุฏ ุงูุทูุจุงุช ุงููุดุทุฉ ุจุงูุชุธุงุฑ ุงูุณุงุฆู
SELECT COUNT(*) 
FROM orders 
WHERE status = 'pending' 
  AND driver_id IS NULL;

-- ูุชูุณุท ุนุฏุฏ ุงููุญุงููุงุช
SELECT AVG(retry_count) 
FROM orders 
WHERE created_at > NOW() - INTERVAL '7 days';

-- ูุณุจุฉ ูุฌุงุญ ุงููุญุงููุฉ ุงูุฃููู
SELECT 
  COUNT(*) FILTER (WHERE retry_count = 0 AND driver_id IS NOT NULL) * 100.0 / 
  COUNT(*) as first_attempt_success_rate
FROM orders
WHERE created_at > NOW() - INTERVAL '7 days';
```

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ

1. **ุฅุดุนุงุฑุงุช ููุฑูุฉ** ุนูุฏ ูู ูุญุงููุฉ
2. **ุชุญูููุงุช ูุชูุฏูุฉ** ูุฃููุงุช ุงูุฐุฑูุฉ
3. **ุชุนุฏูู dynamic** ููููุช ุญุณุจ ุงูููุทูุฉ
4. **ูุธุงู bonus** ููุณุงุฆููู ุงูุฃุณุฑุน ูู ุงูุฑุฏ
5. **ุณุฌู ูุงูู** ููู ูุญุงููุฉ

---

## ๐ ููุงุญุธุงุช

- โ๏ธ ุงูุชุฃูุฏ ูู ุชุดุบูู Realtime ูู Supabase
- โ๏ธ ุงูู countdown ูุนูู ุนูู client-side ููุท
- โ ุงูู retry ูุนูู server-side ุนุจุฑ RPC
- โ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ูุญููุฉ ุจู RLS

---

## ๐จโ๐ป ุงููููุงุช ุงููุนุฏูุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `create_app_settings.sql` - ุงูุฌุฏูู ูุงูู functions

### Components
- `components/OrderCountdownBar.tsx` - ุดุฑูุท ุงูุนุฏ ุงูุชูุงุฒูู
- `components/OrderCard.tsx` - ุฅุถุงูุฉ countdown ู retry button

### Hooks
- `hooks/useOrderCountdown.ts` - ููุทู ุงูุนุฏ ุงูุชูุงุฒูู
- `hooks/useAutoRetry.ts` - ููุทู ุฅุนุงุฏุฉ ุงููุญุงููุงุช

### Screens
- `app/(tabs)/driver/trips.tsx` - countdown ููุณุงุฆู
- `app/(tabs)/customer/my-orders.tsx` - countdown + retry ููุนููู
- `app/(tabs)/admin/settings.tsx` - ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **ูุธุงู ูุชูุงูู** ูุฅุฏุงุฑุฉ ุฅุนุงุฏุฉ ุงููุญุงููุงุช
โ **ูุงุฌูุฉ ุณููุฉ** ููุนููู ูุงูุณุงุฆู
โ **ุชุญูู ูุงูู** ููุฅุฏุงุฑุฉ ูู ุงูุฅุนุฏุงุฏุงุช
โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ** ูุน countdown ู progress bars
โ **ุฃูุงู ุนุงูู** ูุน RLS
โ **ุฃุฏุงุก ููุชุงุฒ** ูุน Realtime subscriptions

๐ **ุฌุงูุฒ ููุฅูุชุงุฌ!**











