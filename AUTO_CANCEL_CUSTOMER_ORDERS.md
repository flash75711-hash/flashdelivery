# ๐ ูุธุงู ุงูุฅูุบุงุก ุงูุชููุงุฆู ููุทูุจุงุช - ุฌุงูุจ ุงูุนููู

## ๐ ุงููุดููุฉ

ุนูุฏ **ุงูุนููู** (ุงูุทุฑู ุงูุซุงูู ุงูุฐู ุทูุจ ุงูุทูุจ):
- โ ุจุนุฏ ุงูุชูุงุก ุงููุฏุฉ (`driver_response_deadline`)
- โ ูุงูุชูุงุก ุฌููุน ุงููุญุงููุงุช (`retry_count >= max_auto_retry_attempts`)
- โธ๏ธ ูุธู ุงูุทูุจ ููุชูุจุงู **"ููุฏ ุงูุงูุชุธุงุฑ"** (`status = 'pending'`)
- ๐ ูุง ูุชุญูู ุชููุงุฆูุงู ุฅูู **"ููุบู"** (`status = 'cancelled'`)

---

## โ ุงูุญููู ุงูููุทุจูุฉ

### 1๏ธโฃ ุชุญุฏูุซ `useAutoRetry` Hook

**ุงูููู:** `hooks/useAutoRetry.ts`

**ุงูุชุนุฏูู:**
```typescript
// ุนูุฏ ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ุงููุญุงููุงุช
if (currentRetries >= settings.maxRetries) {
  console.log('๐ ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ุงููุญุงููุงุชุ ุฅูุบุงุก ุงูุทูุจ:', orderId);
  
  // ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู cancelled
  const { error: cancelError } = await supabase
    .from('orders')
    .update({ 
      status: 'cancelled',
      search_status: 'stopped'
    })
    .eq('id', orderId);
  
  if (cancelError) {
    console.error('โ ุฎุทุฃ ูู ุฅูุบุงุก ุงูุทูุจ:', cancelError);
  } else {
    console.log('โ ุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ ุงูุชูุงุก ุงููุญุงููุงุช');
  }
  return;
}
```

**ุงููุชูุฌุฉ:** 
- โ ุนูุฏ ุงูุชูุงุก ุงููุญุงููุงุชุ ูุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูุง ุญุงุฌุฉ ูุชุฏุฎู ูุฏูู ูู ุงูุนููู

---

### 2๏ธโฃ ุฅุถุงูุฉ Polling ูู ุตูุญุฉ ุงูุนููู

**ุงูููู:** `app/(tabs)/customer/my-orders.tsx`

**ุงูุชุนุฏูู:**
```typescript
// ุงูุชุญูู ุงูุฏูุฑู ูู ุงูุทูุจุงุช ุงูููุชููุฉ ูุฅูุบุงุกูุง ุชููุงุฆูุงู
React.useEffect(() => {
  const checkExpiredOrders = async () => {
    try {
      // ุงุณุชุฏุนุงุก ุงููุธููุฉ ุงูุชููุงุฆูุฉ ูุฅูุบุงุก ุงูุทูุจุงุช ุงูููุชููุฉ
      const { data, error } = await supabase.rpc('auto_cancel_expired_orders');
      
      if (error) {
        console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุทูุจุงุช ุงูููุชููุฉ:', error);
      } else if (data && data.length > 0) {
        console.log(`โ ุชู ุฅูุบุงุก ${data.length} ุทูุจุงุช ููุชููุฉ ุชููุงุฆูุงู`);
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุทูุจุงุช ูุชุญุฏูุซ ุงููุงุฌูุฉ
        reload();
      }
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู checkExpiredOrders:', error);
    }
  };

  // ุงูุชุญูู ููุฑุงู ุนูุฏ ุงูุชุญููู
  checkExpiredOrders();

  // ุงูุชุญูู ูู 15 ุซุงููุฉ
  const interval = setInterval(checkExpiredOrders, 15000);

  return () => clearInterval(interval);
}, [reload]);
```

**ุงููุชูุฌุฉ:**
- โ ูู **15 ุซุงููุฉ**ุ ูุชู ูุญุต ุงูุทูุจุงุช ุงูููุชููุฉ
- โ ุฅุฐุง ูุฌุฏุช ุทูุจุงุช ููุชููุฉุ ูุชู ุฅูุบุงุคูุง ูุชุญุฏูุซ ุงููุงุฌูุฉ
- โ ูุนูู ุญุชู ูู ูุดู Realtime

---

### 3๏ธโฃ ุชุญุฏูุซ `OrderCard` Component

**ุงูููู:** `components/OrderCard.tsx`

**ุงูุชุนุฏูู:**
```typescript
// ูุนุงูุฌุฉ ุงูุชูุงุก ุงูููุช
const handleExpire = async () => {
  console.log('โฐ [OrderCard] ุงูุนุฏุงุฏ ุงูุชูู ููุทูุจ:', order.id);
  setIsExpired(true);
  
  // ุฅุฐุง ูุงู ุงูุนููู ูุงูุชูุช ุงููุญุงููุงุชุ ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู
  if (isCustomer && (order.retry_count || 0) >= maxRetries) {
    console.log('๐ [OrderCard] ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ ุงูุชูุงุก ุงููุญุงููุงุช');
    try {
      const { error } = await supabase
        .from('orders')
        .update({ 
          status: 'cancelled',
          search_status: 'stopped'
        })
        .eq('id', order.id);
      
      if (error) {
        console.error('โ [OrderCard] ุฎุทุฃ ูู ุฅูุบุงุก ุงูุทูุจ:', error);
      } else {
        console.log('โ [OrderCard] ุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู');
        // ุงุณุชุฏุนุงุก onCancel ุฅุฐุง ูุงู ููุฌูุฏุงู ูุชุญุฏูุซ ุงููุงุฌูุฉ
        if (onCancel) {
          onCancel(order);
        }
      }
    } catch (error) {
      console.error('โ [OrderCard] ุฎุทุฃ ูู handleExpire:', error);
    }
  }
};
```

**ุงููุชูุฌุฉ:**
- โ ุนูุฏ ุงูุชูุงุก ุงูุนุฏุงุฏ (`OrderCountdownBar`)ุ ูุชู ุฅูุบุงุก ุงูุทูุจ ููุฑุงู
- โ ูุชู ุชุญุฏูุซ ุงููุงุฌูุฉ ุชููุงุฆูุงู
- โ ูุฑู ุงูุนููู ุญุงูุฉ "ููุบู" ุจุฏูุงู ูู "ููุฏ ุงูุงูุชุธุงุฑ"

---

## ๐ ุงูุณููุงุฑูู ุงููุงูู

### ูุซุงู ุนููู:

```
1๏ธโฃ ุงูุนููู ูุทูุจ ุทูุจ (status = 'pending')
   โฐ deadline = NOW() + 5 ุฏูุงุฆู
   ๐ข retry_count = 0
   ๐ max_retries = 3

2๏ธโฃ ุจุนุฏ 5 ุฏูุงุฆู:
   โฐ ุงูููุช ุงูุชูู!
   ๐ useAutoRetry ูุนูุฏ ุงููุญุงููุฉ (retry_count = 1)
   โฐ deadline ุฌุฏูุฏ = NOW() + 5 ุฏูุงุฆู

3๏ธโฃ ุจุนุฏ 5 ุฏูุงุฆู ุฃุฎุฑู:
   โฐ ุงูููุช ุงูุชูู ูุฑุฉ ุซุงููุฉ!
   ๐ useAutoRetry ูุนูุฏ ุงููุญุงููุฉ (retry_count = 2)
   โฐ deadline ุฌุฏูุฏ = NOW() + 5 ุฏูุงุฆู

4๏ธโฃ ุจุนุฏ 5 ุฏูุงุฆู ุฃุฎุฑู:
   โฐ ุงูููุช ุงูุชูู ูููุฑุฉ ุงูุซุงูุซุฉ!
   ๐ useAutoRetry ูุนูุฏ ุงููุญุงููุฉ (retry_count = 3)
   โฐ deadline ุฌุฏูุฏ = NOW() + 5 ุฏูุงุฆู

5๏ธโฃ ุจุนุฏ 5 ุฏูุงุฆู ุฃุฎุฑู:
   โฐ ุงูููุช ุงูุชูู ูููุฑุฉ ุงูุฑุงุจุนุฉ!
   โ retry_count (3) >= max_retries (3)
   
   ๐จ ูุชู ุงูุฅูุบุงุก ุงูุชููุงุฆู:
   โ useAutoRetry: ูุญุฏุซ status = 'cancelled'
   โ OrderCard: onExpire ูุญุฏุซ status = 'cancelled'
   โ Polling (ูู 15 ุซุงููุฉ): ูุชุญูู ูููุบู
   
   ุงููุชูุฌุฉ:
   ๐ status = 'cancelled'
   ๐ search_status = 'stopped'
   ๐ค ุงูุนููู ูุฑู: "ููุบู" โ
```

---

## ๐ ุงูููุงุฑูุฉ: ูุจู ูุจุนุฏ

### โ ูุจู ุงูุชุนุฏูู:

```
ุงูุนููู:
๐ฆ ุงูุทูุจ #12345
โธ๏ธ ููุฏ ุงูุงูุชุธุงุฑ
โฐ ุงูุชูู ุงูููุช ููุฐ 10 ุฏูุงุฆู
โ ูุง ุดูุก ูุญุฏุซ!
๐ ูุธู "ููุฏ ุงูุงูุชุธุงุฑ" ููุฃุจุฏ
```

### โ ุจุนุฏ ุงูุชุนุฏูู:

```
ุงูุนููู:
๐ฆ ุงูุทูุจ #12345
โฐ ุงูุนุฏุงุฏ: 00:00 (ุงูุชูู!)
๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ (1/3)...
โฐ ุงูุนุฏุงุฏ: 05:00 (ุฌุฏูุฏ)

โฐ ุงูุนุฏุงุฏ: 00:00 (ุงูุชูู ูุฑุฉ ุฃุฎุฑู!)
๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ (2/3)...
โฐ ุงูุนุฏุงุฏ: 05:00 (ุฌุฏูุฏ)

โฐ ุงูุนุฏุงุฏ: 00:00 (ุงูุชูู ูููุฑุฉ ุงูุซุงูุซุฉ!)
๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ (3/3)...
โฐ ุงูุนุฏุงุฏ: 05:00 (ุฌุฏูุฏ)

โฐ ุงูุนุฏุงุฏ: 00:00 (ุงูุชูู ูููุฑุฉ ุงูุฑุงุจุนุฉ!)
โ ุงูุชูุช ุงููุญุงููุงุช!
โ ุชู ุงูุฅูุบุงุก ุชููุงุฆูุงู
๐ค ุงูุญุงูุฉ: "ููุบู" โ
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุณุฑูุน (30 ุซุงููุฉ):

```sql
-- ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ูุงุฎุชุจุงุฑ ุณุฑูุน
UPDATE app_settings 
SET setting_value = '10' 
WHERE setting_key = 'driver_response_timeout'; -- 10 ุซูุงูู

UPDATE app_settings 
SET setting_value = '2' 
WHERE setting_key = 'max_auto_retry_attempts'; -- 2 ูุญุงููุงุช ููุท
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โฐ ุจุนุฏ 10 ุซูุงูู: ูุญุงููุฉ 1
- โฐ ุจุนุฏ 20 ุซุงููุฉ: ูุญุงููุฉ 2
- โฐ ุจุนุฏ 30 ุซุงููุฉ: **ุฅูุบุงุก ุชููุงุฆู** โ

### 2. ูุฑุงูุจุฉ Console:

```javascript
// ุนูุฏ ุงูุชูุงุก ุงูุนุฏุงุฏ:
โฐ [OrderCard] ุงูุนุฏุงุฏ ุงูุชูู ููุทูุจ: abc123
๐ [OrderCard] ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ ุงูุชูุงุก ุงููุญุงููุงุช
โ [OrderCard] ุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู

// ูู Polling:
โ ุชู ุฅูุบุงุก 1 ุทูุจุงุช ููุชููุฉ ุชููุงุฆูุงู

// ูู useAutoRetry:
๐ ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ุงููุญุงููุงุชุ ุฅูุบุงุก ุงูุทูุจ: abc123
โ ุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ ุงูุชูุงุก ุงููุญุงููุงุช
```

---

## ๐ ูููุงุช ุฐุงุช ุตูุฉ

1. `hooks/useAutoRetry.ts` - ููุทู ุฅุนุงุฏุฉ ุงููุญุงููุงุช ุงูุชููุงุฆูุฉ
2. `app/(tabs)/customer/my-orders.tsx` - ุตูุญุฉ ุทูุจุงุช ุงูุนููู
3. `components/OrderCard.tsx` - ุจุทุงูุฉ ุนุฑุถ ุงูุทูุจ
4. `components/OrderCountdownBar.tsx` - ุดุฑูุท ุงูุนุฏ ุงูุชูุงุฒูู
5. `hooks/useOrderCountdown.ts` - Hook ููุนุฏุงุฏ
6. `auto_cancel_expired_orders.sql` - ูุธููุฉ SQL ููุฅูุบุงุก ุงูุชููุงุฆู
7. `create_app_settings.sql` - ุฅุนุฏุงุฏุงุช ุงููุธุงู

---

## ๐ ููุงุญุธุงุช ูููุฉ

### โ๏ธ ุงูุชูููุช:

1. **useAutoRetry**: ูุนูู ูู ุงูุฎูููุฉุ ูุชุญูู ุนูุฏ ุงูุชูุงุก `deadline`
2. **Polling (15s)**: ุงุญุชูุงุทูุ ูุนูู ูู 15 ุซุงููุฉ
3. **OrderCountdownBar**: ููุฑูุ ููุบู ุนูุฏ `onExpire`

### โ ุงูุฃูุงู:

- โ **RLS Policies**: ุงูุนููู ููููู ููุท ุชุญุฏูุซ ุทูุจุงุชู
- โ **Validation**: ุงูุชุญูู ูู `retry_count` ู `max_retries`
- โ **Error Handling**: ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก

### ๐ฏ ุงูุชูุงูู:

- โ **Web**: ูุนูู ุจุดูู ูุงูู
- โ **Mobile**: ูุนูู ุจุดูู ูุงูู
- โ **Realtime**: ูุชูุงูู ูุน Supabase Realtime

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ (ุงุฎุชูุงุฑูุฉ)

### 1. ุฅุดุนุงุฑ ูุจู ุงูุฅูุบุงุก:
```typescript
// ูุจู 1 ุฏูููุฉ ูู ุงูุฅูุบุงุก ุงูููุงุฆู
if (timeLeft === 60 && retry_count === max_retries) {
  Alert.alert(
    'โ๏ธ ุชูุจูู',
    'ุณูุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ ุฏูููุฉ ูุงุญุฏุฉ ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุงุฆู'
  );
}
```

### 2. ุฒุฑ "ุชูุฏูุฏ ุงูููุช":
```typescript
// ุงูุณูุงุญ ููุนููู ุจุชูุฏูุฏ ุงูููุช ูุญุงููุฉ ุฅุถุงููุฉ
<TouchableOpacity onPress={handleExtendTime}>
  <Text>โฑ๏ธ ุชูุฏูุฏ ุงูููุช (+5 ุฏูุงุฆู)</Text>
</TouchableOpacity>
```

### 3. ุฅุญุตุงุฆูุงุช ูููุฏูุฑ:
```sql
-- ุนุฏุฏ ุงูุทูุจุงุช ุงูููุบุงุฉ ุชููุงุฆูุงู
SELECT COUNT(*) 
FROM orders 
WHERE status = 'cancelled' 
  AND search_status = 'stopped'
  AND retry_count >= 3;
```

---

**โ ุชู ุงูุชุทุจูู ุจูุฌุงุญ! ุงูุขู ุงูุทูุจุงุช ุชููุบู ุชููุงุฆูุงู ุนูุฏ ุงูุนููู ุจุนุฏ ุงูุชูุงุก ุงููุญุงููุงุช!** ๐











