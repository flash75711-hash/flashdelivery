# ๐ ูุฑุงุฌุนุฉ ุงูุณููุงุฑูููุงุช ุจูู ุงูุณุงุฆู ูุงูุฃุทุฑุงู ุงูุฃุฎุฑู

## ๐ ูุธุฑุฉ ุนุงูุฉ ุนูู ุชุฏูู ุงูุทูุจุงุช

### ุญุงูุงุช ุงูุทูุจ (Order Status Flow)
```
pending โ accepted โ pickedUp โ inTransit โ completed
   โ
cancelled (ูู ุฃู ูุฑุญูุฉ)
```

---

## ๐ ุงูุณุงุฆู โ๏ธ ุงูุนููู (Driver โ๏ธ Customer)

### 1๏ธโฃ **ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ (Order Creation)**

**ุงูุนููู:**
- ููุดุฆ ุทูุจ ูู `/orders/deliver-package` ุฃู `/orders/outside-order`
- ุงูุทูุจ ูููุดุฃ ุจุญุงูุฉ `pending`
- ูุชู ุงูุจุญุซ ุงูุชููุงุฆู ุนู ุณุงุฆู (ุฅุฐุง ูุงู ููุนูู)

**ุงูุณุงุฆู:**
- ูุชููู ุฅุดุนุงุฑ "ุทูุจ ุฌุฏูุฏ ูุชุงุญ" ุนุจุฑ:
  - `FloatingOrderNotification` (ุฅุฐุง ูุงู ุงูุทูุจ ููุฌู ูู)
  - `useOrderNotifications` (Web ููุท - In-App notification)
- ูุธูุฑ ุงูุทูุจ ูู ุตูุญุฉ `/driver/trips` (ูุงุฆูุฉ ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ)

---

### 2๏ธโฃ **ูุจูู ุงูุทูุจ (Order Acceptance)**

**ุณููุงุฑูู ุฃ: ูุจูู ูุจุงุดุฑ (ุจุฏูู ุชูุงูุถ)**
```
ุงูุณุงุฆู โ ูุถุบุท "ูุจูู ุงูุทูุจ" โ status = 'accepted'
  โ
ุฅุดุนุงุฑ ููุนููู: "ุชู ูุจูู ุทูุจู"
  โ
ุจุฏุก ุชุชุจุน ุงููููุน (Location Tracking)
```

**ุณููุงุฑูู ุจ: ูุน ุงูุชูุงูุถ**
```
ุงูุณุงุฆู โ ูุถุบุท "ูุจูู ุงูุทูุจ" ุฃู "ุชูุงูุถ"
  โ
ููุชุญ Modal ุงูุชูุงูุถ
  โ
ููููู:
  - ูุจูู ุงูุณุนุฑ ุงูุฃุตูู
  - ุงูุชุฑุงุญ ุณุนุฑ ุฌุฏูุฏ
  - ูุจูู ุณุนุฑ ูุชูู ุนููู (ุฅุฐุง ูุงู ููุฌูุฏ)
  โ
ุจุนุฏ ุงูููุงููุฉ โ status = 'accepted'
```

**ุงูููุฏ:** `app/(tabs)/driver/trips.tsx`
- `acceptOrder()` - ูุจูู ูุจุงุดุฑ
- `acceptNegotiatedPrice()` - ูุจูู ุจุนุฏ ุชูุงูุถ
- `proposePrice()` - ุงูุชุฑุงุญ ุณุนุฑ ุฌุฏูุฏ

---

### 3๏ธโฃ **ุงูุชูุงูุถ ุนูู ุงูุณุนุฑ (Price Negotiation)**

**ุงูุณุงุฆู ููุชุฑุญ ุณุนุฑ:**
```
ุงูุณุงุฆู โ ูุฏุฎู ุณุนุฑ ูู Modal ุงูุชูุงูุถ
  โ
ูุถุบุท "ุฅุฑุณุงู ุงูุงูุชุฑุงุญ"
  โ
ุชุญุฏูุซ: driver_proposed_price, negotiation_status = 'driver_proposed'
  โ
ุฅุดุนุงุฑ ููุนููู: "ุงูุชุฑุญ ุงูุณุงุฆู ุณุนุฑ ุฌุฏูุฏ: X ุฌ.ู"
```

**ุงูุนููู ููุชุฑุญ ุณุนุฑ:**
```
ุงูุนููู โ ูู ุตูุญุฉ ุชูุงุตูู ุงูุทูุจ
  โ
ูุฏุฎู ุณุนุฑ ููุถุบุท "ุฅุฑุณุงู ุงูุงูุชุฑุงุญ"
  โ
ุชุญุฏูุซ: customer_proposed_price, negotiation_status = 'customer_proposed'
  โ
ุฅุดุนุงุฑ ููุณุงุฆู: "ุงูุนููู ููุชุฑุญ ุณุนุฑ ุฌุฏูุฏ"
```

**ุงูุนููู ููุจู ุงูุชุฑุงุญ ุงูุณุงุฆู:**
```
ุงูุนููู โ ูุถุบุท "ูุจูู ุงูุชุฑุงุญ ุงูุณุงุฆู"
  โ
ุชุญุฏูุซ: negotiated_price, negotiation_status = 'accepted'
  โ
ุฅุดุนุงุฑ ููุณุงุฆู: "ุชู ูุจูู ุงูุชุฑุงุญู"
```

**ุงูููุฏ:**
- ุงูุณุงุฆู: `app/(tabs)/driver/trips.tsx` โ `proposePrice()`
- ุงูุนููู: `app/orders/[id].tsx` โ `proposePrice()`, `acceptDriverProposal()`

---

### 4๏ธโฃ **ุชู ุงูุงุณุชูุงู (Picked Up)**

```
ุงูุณุงุฆู โ ูุถุบุท "ุชู ุงูุงุณุชูุงู"
  โ
ุชุญุฏูุซ: status = 'pickedUp'
  โ
ุฅุดุนุงุฑ ููุนููู: "ุชู ุงุณุชูุงู ุทูุจู ูู ููุทุฉ ุงูุงุณุชูุงู"
```

**ุงูููุฏ:** `app/(tabs)/driver/trips.tsx` โ `markPickedUp()`

---

### 5๏ธโฃ **ุชู ุงูุชูุตูู (Delivered)**

```
ุงูุณุงุฆู โ ูุถุบุท "ุชู ุงูุชูุตูู"
  โ
ุชุญุฏูุซ: status = 'completed', completed_at = NOW()
  โ
ุฅุถุงูุฉ ุงููุจูุบ ุฅูู ูุญูุธุฉ ุงูุณุงุฆู:
  - amount = total_fee - commission (10%)
  - commission = total_fee * 0.1
  โ
ุฅุดุนุงุฑ ููุนููู: "ุชู ุฅููุงู ุทูุจู ุจูุฌุงุญ"
  โ
ุงูุณุงุฆู: ุฅุดุนุงุฑ "ุชู ุฅุถุงูุฉ X ุฌ.ู ุฅูู ูุญูุธุชู"
```

**ุงูููุฏ:** `app/(tabs)/driver/trips.tsx` โ `markDelivered()`

---

### 6๏ธโฃ **ุฅูุบุงุก ุงูุทูุจ (Order Cancellation)**

**ุงูุนููู ููุบู:**
```
ุงูุนููู โ ูุถุบุท "ุฅูุบุงุก ุงูุทูุจ" (ููุท ูู ุญุงูุฉ pending)
  โ
ุชุญุฏูุซ: status = 'cancelled'
  โ
ุฅุดุนุงุฑ ููุณุงุฆู: "ุชู ุฅูุบุงุก ุงูุทูุจ" (ุฅุฐุง ูุงู ููุจูู)
```

**ุงูุณุงุฆู ููุบู:**
```
ุงูุณุงุฆู โ ูุถุบุท "ุฅูุบุงุก ุงูุทูุจ" (ููุท ูู ุญุงูุฉ pending ุฃู accepted)
  โ
ุชุญุฏูุซ: status = 'cancelled', driver_id = null
  โ
ุฅุดุนุงุฑ ููุนููู: "ุชู ุฅูุบุงุก ุงูุทูุจ ูู ูุจู ุงูุณุงุฆู"
```

**ุงูููุฏ:**
- ุงูุนููู: `app/(tabs)/customer/my-orders.tsx` โ `handleCancelOrder()`
- ุงูุณุงุฆู: `app/(tabs)/driver/my-orders.tsx` โ `handleCancelOrder()`

---

## ๐ ุงูุณุงุฆู โ๏ธ ุงูุฅุฏุงุฑุฉ (Driver โ๏ธ Admin)

### 1๏ธโฃ **ุงูููุงููุฉ ุนูู ุงูุณุงุฆู (Driver Approval)**

```
ุงูุฅุฏุงุฑุฉ โ ุตูุญุฉ /admin/drivers
  โ
ุชูุญุต ุจูุงูุงุช ุงูุณุงุฆู (ุจุทุงูุฉ ุดุฎุตูุฉุ ุตูุฑุฉ ุดุฎุตูุฉ)
  โ
ุชุถุบุท "ููุงููุฉ" โ approval_status = 'approved', status = 'active'
  โ
ุฅุดุนุงุฑ ููุณุงุฆู: "ุชูุช ุงูููุงููุฉ ุนูู ุชุณุฌููู"
```

**ุงูููุฏ:** `app/(tabs)/admin/drivers.tsx` โ `approveDriver()`

---

### 2๏ธโฃ **ุชุนููู ุงูุณุงุฆู (Driver Suspension)**

```
ุงูุฅุฏุงุฑุฉ โ ุตูุญุฉ /admin/drivers
  โ
ุชุถุบุท "ุชุนููู" โ status = 'suspended'
  โ
ุงูุณุงุฆู ูุง ูุณุชุทูุน ุงุณุชูุจุงู ุทูุจุงุช ุฌุฏูุฏุฉ
```

**ุงูููุฏ:** `app/(tabs)/admin/drivers.tsx` โ `suspendDriver()`

---

### 3๏ธโฃ **ุฅูุบุงุก ุชุนููู ุงูุณุงุฆู (Driver Reactivation)**

```
ุงูุฅุฏุงุฑุฉ โ ุตูุญุฉ /admin/drivers
  โ
ุชุถุบุท "ุฅูุบุงุก ุงูุชุนููู" โ status = 'active'
  โ
ุงูุณุงุฆู ูุนูุฏ ููุนูู
```

**ุงูููุฏ:** `app/(tabs)/admin/drivers.tsx` โ `reactivateDriver()`

---

### 4๏ธโฃ **ูุชุงุจุนุฉ ุงูุทูุจุงุช (Order Monitoring)**

```
ุงูุฅุฏุงุฑุฉ โ ุตูุญุฉ /admin/orders
  โ
ุชุฑู ุฌููุน ุงูุทูุจุงุช (pending, accepted, completed, cancelled)
  โ
ูููููุง ุฑุคูุฉ ุชูุงุตูู ูู ุทูุจ
```

**ุงูููุฏ:** `app/(tabs)/admin/orders.tsx`

---

### 5๏ธโฃ **ุงููุญุงุณุจุฉ (Accounting)**

```
ุงูุฅุฏุงุฑุฉ โ ุตูุญุฉ /admin/accounting
  โ
ุชุฑู ูุณุชุญูุงุช ุงูุณุงุฆููู ุงูุฃุณุจูุนูุฉ
  โ
ุชุถุบุท "ุชู ุงูุชุญุตูู" โ is_debt_cleared = true
```

**ุงูููุฏ:** `app/(tabs)/admin/accounting.tsx` โ `markAsCollected()`

---

## ๐ ูุธุงู ุงูุฅุดุนุงุฑุงุช (Notifications System)

### ููุนููู (Customer Notifications):
1. โ "ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ" - ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ
2. โ "ุชู ูุจูู ุทูุจู" - ุนูุฏ ูุจูู ุงูุณุงุฆู
3. โ "ุงูุชุฑุญ ุงูุณุงุฆู ุณุนุฑ ุฌุฏูุฏ" - ุนูุฏ ุงูุชุฑุงุญ ุงูุณุงุฆู ุณุนุฑ
4. โ "ุชู ุงุณุชูุงู ุงูุทูุจ" - ุนูุฏ markPickedUp
5. โ "ุงูุทูุจ ููุฏ ุงูุชูุตูู" - (ุฅู ูุฌุฏ)
6. โ "ุชู ุฅููุงู ุงูุทูุจ" - ุนูุฏ markDelivered
7. โ๏ธ "ุชู ุฅูุบุงุก ุงูุทูุจ" - ุนูุฏ ุงูุฅูุบุงุก

### ููุณุงุฆู (Driver Notifications):
1. โ "ุทูุจ ุฌุฏูุฏ ูุชุงุญ" - ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ (Web ููุท)
2. โ "ุชู ูุจูู ุงูุชุฑุงุญู" - ุนูุฏ ูุจูู ุงูุนููู ูุงูุชุฑุงุญ ุงูุณุนุฑ
3. โ "ุงูุชุฑุงุญ ุณุนุฑ ุฌุฏูุฏ" - ุนูุฏ ุงูุชุฑุงุญ ุงูุนููู ุณุนุฑ
4. โ "ุชู ุฅุถุงูุฉ X ุฌ.ู ุฅูู ูุญูุธุชู" - ุนูุฏ ุฅููุงู ุงูุทูุจ
5. โ "ุชูุช ุงูููุงููุฉ ุนูู ุชุณุฌููู" - ุนูุฏ ููุงููุฉ ุงูุฅุฏุงุฑุฉ
6. โ๏ธ "ุชู ุฅูุบุงุก ุงูุทูุจ" - ุนูุฏ ุฅูุบุงุก ุงูุนููู

### ููุฅุฏุงุฑุฉ (Admin Notifications):
- ุงูุฅุฏุงุฑุฉ ุชุฑู ุฌููุน ุงูุทูุจุงุช ูุจุงุดุฑุฉ ูู Dashboard
- ูููููุง ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูุฌููุน ุงููุณุชุฎุฏููู

---

## ๐ ุงููุดุงูู ุงููุญุชููุฉ ูุงูุณููุงุฑูููุงุช ุงูููููุฏุฉ

### โ๏ธ ูุดุงูู ูุญุชููุฉ:

1. **ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `inTransit`:**
   - ุงูููุฏ ูุง ูุญุฏุซ ุงูุญุงูุฉ ุฅูู `inTransit` ุจุดูู ุตุฑูุญ
   - ุจุนุฏ `pickedUp`ุ ูุฌุจ ุชุญุฏูุซูุง ุฅูู `inTransit` ุชููุงุฆูุงู ุฃู ูุฏููุงู

2. **ุชุชุจุน ุงููููุน (Location Tracking):**
   - `startLocationTracking()` ูุจุฏุฃ ุชุชุจุน ุงููููุน ูู 5 ุซูุงูู
   - ููู ูุง ููุฌุฏ cleanup logic ุนูุฏ ุฅููุงู ุงูุทูุจ
   - ูุฌุจ ุฅุถุงูุฉ `clearInterval` ุนูุฏ completion

3. **ุงูุชูุงูุถ:**
   - ุงูุณุงุฆู ููููู ุงูุชุฑุงุญ ุณุนุฑุ ูุงูุนููู ููุจู
   - ููู ูุง ููุฌุฏ ุณููุงุฑูู ูุงุถุญ ููุง ูุญุฏุซ ุฅุฐุง ุฑูุถ ุงูุนููู ุฃู ุงูุชุฑุญ ุณุนุฑ ูุฎุชูู
   - ูุฌุจ ุชูุถูุญ ุชุฏูู ุงูุชูุงูุถ

4. **ุฅูุบุงุก ุงูุทูุจ ุจุนุฏ ุงููุจูู:**
   - ุงูููุฏ ูุณูุญ ููุณุงุฆู ุจุงูุฅูุบุงุก ูู ุญุงูุฉ `pending`
   - ููู ูุงุฐุง ุนู `accepted`ุ ูุฌุจ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

5. **ุฅุดุนุงุฑุงุช Web ููุท:**
   - `useOrderNotifications` ูุนูู ุนูู Web ููุท
   - ุงูุณุงุฆููู ุนูู Web ููุท ุณูุณุชููุฏูู ูู In-App notifications
   - ุนูู ุงูููุจุงููุ ูุญุชุงุฌูู Push Notifications (ููุนูู ุญุงููุงู)

---

## โ ุงูุชูุตูุงุช ููุชุญุณูู

### 1. ุฅุถุงูุฉ ุญุงูุฉ `inTransit` ุชููุงุฆูุงู:
```typescript
const markPickedUp = async () => {
  // ุจุนุฏ pickedUpุ ุญุฏุซ ุฅูู inTransit ุจุนุฏ ูุชุฑุฉ
  await supabase.from('orders').update({ status: 'pickedUp' });
  setTimeout(() => {
    supabase.from('orders').update({ status: 'inTransit' });
  }, 5000); // ุจุนุฏ 5 ุซูุงูู
}
```

### 2. ุชูุธูู Location Tracking:
```typescript
const locationIntervalRef = useRef<NodeJS.Timeout | null>(null);

const startLocationTracking = async (orderId: string) => {
  // ุชูุธูู interval ุงูุณุงุจู
  if (locationIntervalRef.current) {
    clearInterval(locationIntervalRef.current);
  }
  
  locationIntervalRef.current = setInterval(async () => {
    // ุชุชุจุน ุงููููุน
  }, 5000);
};

const stopLocationTracking = () => {
  if (locationIntervalRef.current) {
    clearInterval(locationIntervalRef.current);
    locationIntervalRef.current = null;
  }
};
```

### 3. ุชูุถูุญ ุชุฏูู ุงูุชูุงูุถ:
- ุฅุถุงูุฉ ุญุงูุงุช ูุงุถุญุฉ: `pending_negotiation`, `driver_proposed`, `customer_proposed`, `negotiation_accepted`
- ุฅุถุงูุฉ timeout ููุชูุงูุถ (ูุซูุงู 10 ุฏูุงุฆู)

### 4. ุฅุถุงูุฉ ุฑูุถ ุงูุทูุจ ุจูุถูุญ:
```typescript
const rejectOrder = async (orderId: string) => {
  // ุชุญุฏูุซ: rejected_by = 'driver', rejection_reason = ...
  // ุฅุดุนุงุฑ ููุนููู: "ุฑูุถ ุงูุณุงุฆู ุงูุทูุจ"
}
```

---

## ๐ ููุฎุต ุงูุณููุงุฑูููุงุช ุงูุฑุฆูุณูุฉ

| ุงูุณููุงุฑูู | ุงูุทุฑู ุงูุฃูู | ุงูุทุฑู ุงูุซุงูู | ุงูุญุงูุฉ ูุจู | ุงูุญุงูุฉ ุจุนุฏ | ุงูุฅุดุนุงุฑ |
|-----------|------------|-------------|-----------|-----------|---------|
| ุฅูุดุงุก ุทูุจ | ุนููู | ุณุงุฆู | - | pending | "ุทูุจ ุฌุฏูุฏ ูุชุงุญ" |
| ูุจูู ุทูุจ | ุณุงุฆู | ุนููู | pending | accepted | "ุชู ูุจูู ุทูุจู" |
| ุงูุชุฑุงุญ ุณุนุฑ | ุณุงุฆู | ุนููู | pending | driver_proposed | "ุงูุชุฑุญ ุงูุณุงุฆู ุณุนุฑ" |
| ูุจูู ุงูุชุฑุงุญ | ุนููู | ุณุงุฆู | driver_proposed | negotiation_accepted | "ุชู ูุจูู ุงูุชุฑุงุญู" |
| ุชู ุงูุงุณุชูุงู | ุณุงุฆู | ุนููู | accepted | pickedUp | "ุชู ุงุณุชูุงู ุทูุจู" |
| ุชู ุงูุชูุตูู | ุณุงุฆู | ุนููู | pickedUp | completed | "ุชู ุฅููุงู ุงูุทูุจ" |
| ุฅูุบุงุก ุทูุจ | ุนููู/ุณุงุฆู | ุณุงุฆู/ุนููู | pending/accepted | cancelled | "ุชู ุฅูุบุงุก ุงูุทูุจ" |
| ููุงููุฉ ุฅุฏุงุฑุฉ | ุฅุฏุงุฑุฉ | ุณุงุฆู | pending | approved | "ุชูุช ุงูููุงููุฉ" |

