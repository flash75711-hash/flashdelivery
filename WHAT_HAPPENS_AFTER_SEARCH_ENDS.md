# ูุงุฐุง ูุญุฏุซ ุจุนุฏ ุงูุชูุงุก ุงูุจุญุซ ุนู ุงูุณุงุฆูุ

## ๐ ุงูุณููุงุฑูู ุงูุญุงูู

### ุจุนุฏ 60 ุซุงููุฉ ูู ุจุฏุก ุงูุจุญุซ:

#### 1๏ธโฃ **ุชุญุฏูุซ ุญุงูุฉ ุงูุจุญุซ**
```typescript
// ูู start-order-search/index.ts (ุงูุณุทุฑ 297-301)
await supabase
  .from('orders')
  .update({ search_status: 'stopped' })
  .eq('id', order_id);
```
- โ ูุชู ุชุญุฏูุซ `search_status` ูู `'searching'` ุฅูู `'stopped'`
- โ๏ธ **ุงูุทูุจ ูุจูู ูู ุญุงูุฉ `'pending'`** (ูุง ูุชู ุฅูุบุงุคู ุชููุงุฆูุงู)

#### 2๏ธโฃ **ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู**
```typescript
// ูู start-order-search/index.ts (ุงูุณุทุฑ 305-344)
title: 'ุงูุชูู ุงูุจุญุซ ุนู ุณุงุฆู',
message: 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุงุฆู ูู ุงููุทุงู ุงููุญุฏุฏ. ููููู ุฅุนุงุฏุฉ ุงูุจุญุซ ุฃู ุฅูุบุงุก ุงูุทูุจ.',
type: 'warning',
```
- โ ูุชู ุฅุฑุณุงู In-App Notification
- โ ูุชู ุฅุฑุณุงู Push Notification

#### 3๏ธโฃ **ุงููุงุฌูุฉ ููุนููู**
- โ ูุธูุฑ ุฒุฑ "ุฅุนุงุฏุฉ ุงูุจุญุซ ุนู ุณุงุฆู" ูู:
  - `app/(tabs)/customer/my-orders.tsx`
  - `app/orders/[id].tsx`
  - `components/OrderCard.tsx`
- โ ูุธูุฑ ุฒุฑ "ุฅูุบุงุก ุงูุทูุจ" (ุฅุฐุง ูุงู ูุณููุญุงู)
- โ ูุฎุชูู `OrderSearchCountdown` (ูุฃู `search_status = 'stopped'`)

#### 4๏ธโฃ **ุงููุงุฌูุฉ ููุณุงุฆู**
- โ **ุงูุทูุจุงุช ุงููุชูููุฉ ูุง ุชุธูุฑ** ูู `app/(tabs)/driver/trips.tsx`:
```typescript
// ูู trips.tsx (ุงูุณุทุฑ 293-295)
if (order.search_status === 'stopped') {
  return false; // ูุง ูุธูุฑ ุงูุทูุจ
}
```

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ

### 1. **ุงูุทูุจ ูุจูู ูู ุญุงูุฉ `pending`**
- **ุงููุดููุฉ**: ุงูุทูุจ ูุง ูุชู ุฅูุบุงุคู ุชููุงุฆูุงู ุจุนุฏ ุงูุชูุงุก ุงูุจุญุซ
- **ุงููุชูุฌุฉ**: ูุฏ ุชุชุฑุงูู ุทูุจุงุช `pending` ูุน `search_status = 'stopped'`
- **ุงูุญู ุงูุญุงูู**: ุงูุนููู ูุฌุจ ุฃู ููุบู ุงูุทูุจ ูุฏููุงู ุฃู ูุนูุฏ ุงูุจุญุซ

### 2. **ูุง ููุฌุฏ ุฅูุบุงุก ุชููุงุฆู**
- **ุงููุดููุฉ**: ูุง ููุฌุฏ ูุธุงู ูุฅูุบุงุก ุงูุทูุจุงุช ุงูููุชููุฉ ุชููุงุฆูุงู
- **ุงูุญู ุงููุชุงุญ**: ููุฌุฏ `auto_cancel_expired_orders.sql` ูููู **ุบูุฑ ููุนูู ุชููุงุฆูุงู**

---

## โ ุงูุญููู ุงูููุชุฑุญุฉ

### ุงูุญู 1: ุฅูุบุงุก ุชููุงุฆู ุจุนุฏ ุงูุชูุงุก ุงูุจุญุซ (ูุจุงุดุฑุฉ)
```typescript
// ูู start-order-search/index.ts ุจุนุฏ ุงูุณุทุฑ 301
// ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู cancelled ุจุนุฏ ูุชุฑุฉ ุฅุถุงููุฉ (ูุซูุงู 5 ุฏูุงุฆู)
setTimeout(async () => {
  const { data: finalCheck } = await supabase
    .from('orders')
    .select('status, driver_id')
    .eq('id', order_id)
    .single();
  
  if (finalCheck?.status === 'pending' && !finalCheck?.driver_id) {
    await supabase
      .from('orders')
      .update({ 
        status: 'cancelled',
        search_status: 'stopped'
      })
      .eq('id', order_id);
  }
}, 5 * 60 * 1000); // 5 ุฏูุงุฆู ุจุนุฏ ุงูุชูุงุก ุงูุจุญุซ
```

### ุงูุญู 2: ุฅูุบุงุก ุชููุงุฆู ุจุนุฏ ูุชุฑุฉ ูุนููุฉ (ูุซูุงู 10 ุฏูุงุฆู)
```typescript
// ุชุญุฏูุซ search_expires_at ููุดูู ูุชุฑุฉ ุฅุถุงููุฉ
const searchExpiresAt = new Date(searchStartedAt);
searchExpiresAt.setSeconds(searchExpiresAt.getSeconds() + searchDuration + 600); // +10 ุฏูุงุฆู
```

### ุงูุญู 3: ุชูุนูู ูุธููุฉ SQL ุงูุชููุงุฆูุฉ
```sql
-- ุชูุนูู cron job ุฃู scheduled function
-- ูุงุณุชุฏุนุงุก auto_cancel_expired_orders() ูู ุณุงุนุฉ
```

---

## ๐ ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ ููุนููู ุจุนุฏ ุงูุชูุงุก ุงูุจุญุซ

### 1. **ุฅุนุงุฏุฉ ุงูุจุญุซ** โ
- ุงูุนููู ููููู ุงูุถุบุท ุนูู "ุฅุนุงุฏุฉ ุงูุจุญุซ ุนู ุณุงุฆู"
- ุณูุชู:
  - ุชุญุฏูุซ `search_status` ุฅูู `'searching'`
  - ุชุญุฏูุซ `search_started_at` ุฅูู ุงูููุช ุงูุญุงูู
  - ุงุณุชุฏุนุงุก `start-order-search` ูุฑุฉ ุฃุฎุฑู
  - ุงูุจุญุซ ูุจุฏุฃ ูู ุฌุฏูุฏ ุนูู 10 ูู ููุฏุฉ 60 ุซุงููุฉ

### 2. **ุฅูุบุงุก ุงูุทูุจ** โ
- ุงูุนููู ููููู ุฅูุบุงุก ุงูุทูุจ
- ุณูุชู:
  - ุชุญุฏูุซ `status` ุฅูู `'cancelled'`
  - ุฅุฑุณุงู ุฅุดุนุงุฑ ููุณุงุฆู (ุฅู ูุงู ููุฌูุฏุงู)

### 3. **ุงูุงูุชุธุงุฑ** โ๏ธ
- ุงูุทูุจ ูุจูู ูู ุญุงูุฉ `pending` ูุน `search_status = 'stopped'`
- **ูุง ูุธูุฑ ููุณุงุฆููู** (ูููุชุฑ)
- **ูุง ูุชู ุงูุจุญุซ ุชููุงุฆูุงู ูุฑุฉ ุฃุฎุฑู**

---

## ๐ฏ ุงูุชูุตูุงุช

### ุงูุชูุตูุฉ 1: ุฅุถุงูุฉ ุฅูุบุงุก ุชููุงุฆู ุจุนุฏ 10 ุฏูุงุฆู
```typescript
// ุจุนุฏ ุงูุชูุงุก ุงูุจุญุซ ุจู 10 ุฏูุงุฆูุ ุฅูุบุงุก ุชููุงุฆู
setTimeout(async () => {
  // ... ุงูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ
  if (order.status === 'pending' && !order.driver_id) {
    await supabase
      .from('orders')
      .update({ status: 'cancelled' })
      .eq('id', order_id);
  }
}, (searchDuration + 600) * 1000); // 60 ุซุงููุฉ + 10 ุฏูุงุฆู
```

### ุงูุชูุตูุฉ 2: ุชุญุณูู ุฑุณุงูุฉ ุงูุฅุดุนุงุฑ
```typescript
message: `ุงูุชูู ุงูุจุญุซ ุนู ุณุงุฆู ุจุนุฏ ${searchDuration} ุซุงููุฉ. ููููู ุฅุนุงุฏุฉ ุงูุจุญุซ ุฃู ุณูุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ 10 ุฏูุงุฆู.`
```

### ุงูุชูุตูุฉ 3: ุฅุถุงูุฉ countdown ููุฅูุบุงุก ุงูุชููุงุฆู
- ุนุฑุถ ุนุฏุงุฏ ุชูุงุฒูู ููุนููู: "ุณูุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุนุฏ X ุฏูููุฉ"

---

## ๐ ููุฎุต

### ูุง ูุญุฏุซ ุญุงููุงู:
1. โ ุงูุจุญุซ ูุชููู ุจุนุฏ 60 ุซุงููุฉ
2. โ `search_status` ูุตุจุญ `'stopped'`
3. โ ุฅุดุนุงุฑ ููุนููู
4. โ ุฒุฑ ุฅุนุงุฏุฉ ุงูุจุญุซ ูุธูุฑ
5. โ๏ธ **ุงูุทูุจ ูุจูู `pending`** (ูุง ูุชู ุฅูุบุงุคู ุชููุงุฆูุงู)

### ูุง ูููู ุชุญุณููู:
1. ๐ ุฅุถุงูุฉ ุฅูุบุงุก ุชููุงุฆู ุจุนุฏ ูุชุฑุฉ ูุนููุฉ
2. ๐ ุชุญุณูู ุฑุณุงุฆู ุงูุฅุดุนุงุฑุงุช
3. ๐ ุฅุถุงูุฉ countdown ููุฅูุบุงุก ุงูุชููุงุฆู
